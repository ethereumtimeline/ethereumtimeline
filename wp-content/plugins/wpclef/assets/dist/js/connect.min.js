/*! Clef for WordPress - v2.3.1
 * http://getclef.com
 * Licensed GPLv2+ */
(function(e,t){var n;return n=function(){function e(){}return e.getErrorMessage=function(e){return e.error?e.error:e.data&&e.data.error?e.data.error:e},e.getURLParams=function(){var e,t,n,s,i,r,o,c,u;for(n=window.location.search.substring(1),s=n.split("&"),t={},o=0,c=s.length;c>o;o++)i=s[o],u=i.split("="),e=u[0],r=u[1],t[e]=decodeURIComponent(r);return t},e}(),window.ClefUtils=n}).call(this,jQuery,Backbone),function(e,t){var n,s,i,r;return r=t.View.extend({el:e("#clef-tutorial"),messageTemplate:_.template("<div class='<%=type%> tutorial-message'><%=message%></div>"),events:{"click .next":"next","click .previous":"previous","click .done":"done"},slideClass:"sub",initialize:function(t){var n,s,r,o;for(this.opts=t,this.subs=[],n=this.$el.find("."+this.slideClass).filter(this.opts.slideFilterSelector),r=0,o=n.length;o>r;r++)s=n[r],this.subs.push(new i({el:s}));return this.currentSub=this.subs[0],e(window).on("message",this.handleMessages.bind(this)),this.hide(),this.render()},slideUp:function(e){return this.$el.slideUp(e)},hide:function(e){return this.$el.hide(e)},show:function(){return this.$el.fadeIn()},render:function(){return this.currentSub.render()},done:function(){return this.trigger("done")},next:function(){var e;return e=this.subs[_.indexOf(this.subs,this.currentSub)+1],e?(e.isLogin()&&this.loggedIn&&(e=this.subs[_.indexOf(this.subs,this.newSub)+1]),this.currentSub.hide(),e.render(),this.currentSub=e,this.trigger("next")):this.done()},previous:function(){var e;return e=this.subs[_.indexOf(this.subs,this.currentSub)-1],e?(this.currentSub.hide(),e.render(),this.currentSub=e):void 0},handleMessages:function(e){var t;if(e.originalEvent.origin.indexOf(this.opts.clefBase)>=0)return t=e.originalEvent.data,"string"==typeof t&&(t=JSON.parse(t)),t},connectClefAccount:function(t,n){var s,i;return s={_wpnonce:this.opts.nonces.connectClef,identifier:t.identifier,state:t.state},i=function(e){return function(t){return e.showMessage({message:_.template(clefTranslations.messages.error.connect)({error:t}),type:"error"})}}(this),e.post(this.connectClefAction,s).success(function(e){return e.success?"function"==typeof n?n(e):void 0:i(ClefUtils.getErrorMessage(e))}).fail(function(e){return i(e.responseText)})},showMessage:function(t){return this.$currentMessage&&this.$currentMessage.remove(),this.$currentMessage=e(this.messageTemplate(t)).hide().prependTo(this.$el).slideDown(),t.removeNext?this.listenToOnce(this,"next",function(){return this.$currentMessage.slideUp()}):void 0}},{extend:t.View.extend}),i=t.View.extend({initialize:function(t){return this.opts=t,this.setElement(e(this.opts.el))},render:function(){return this.$el.show()},hide:function(){return this.$el.hide()},remove:function(){return this.$el.remove()},find:function(e){return this.$el.find(e)},isLogin:function(){return this.$el.find("iframe.setup").length},isSync:function(){return this.$el.hasClass("sync")&&this.$el.find("iframe").length}}),s=r.extend({connectClefAction:ajaxurl+"?action=connect_clef_account_clef_id",iframePath:"/iframes/application/create/v2",initialize:function(e){return e.slideFilterSelector=".setup",this.inviter=new InviteUsersView(_.extend({el:this.$el.find(".invite-users-container")},e)),this.listenTo(this.inviter,"invited",this.usersInvited),this.constructor.__super__.initialize.call(this,e),this.on("next",this.shouldLoadIFrame)},render:function(){return this.inviter.render(),this.constructor.__super__.render.call(this)},shouldLoadIFrame:function(){return this.currentSub.isSync()?this.loadIFrame(function(e){return function(){return e.currentSub.find(".spinner-container").hide(),e.iframe.fadeIn()}}(this)):void 0},loadIFrame:function(e){var t,n;if(!this.iframe)return this.iframe=this.$el.find("iframe.setup"),t=encodeURIComponent(this.opts.setup.affiliates.join(",")),n=""+this.opts.clefBase+this.iframePath+"?source="+encodeURIComponent(this.opts.setup.source)+"&domain="+encodeURIComponent(this.opts.setup.siteDomain)+"&logout_hook="+encodeURIComponent(this.opts.setup.logoutHook)+"&name="+encodeURIComponent(this.opts.setup.siteName)+"&affiliates="+t,this.iframe.attr("src",n),this.iframe.on("load",e)},handleMessages:function(e){return(e=this.constructor.__super__.handleMessages.call(this,e))?"keys"===e.type?this.connectClefAccount({identifier:e.clefID},function(t){return function(){return t.trigger("applicationCreated",e),t.next(),t.showMessage({message:clefTranslations.messages.success.connect,type:"updated",removeNext:!0})}}(this)):"error"===e.type?this.showMessage({message:_.template(clefTranslations.messages.error.create)({error:e.message}),type:"error"}):void 0:void 0},onConfigured:function(){return setTimeout(function(){return e(".logout-hook-error").slideDown()},2e4)},usersInvited:function(){return this.inviter.hideButton(),setTimeout(function(e){return function(){return e.currentSub.$el.hasClass("invite")?e.currentSub.$el.find(".button").addClass("button-primary"):void 0}}(this),1e3)}}),n=r.extend({connectClefAction:ajaxurl+"?action=connect_clef_account_oauth_code",render:function(){return this.addButton(),this.constructor.__super__.render.call(this)},addButton:function(){var t,n;if(!this.button)return t=window.location.href,t+=/\?/.test(t)?"&connect_clef_account=1":"?connect_clef_account=1",n=e("#clef-button-target").attr("data-app-id",this.opts.appID).attr("data-redirect-url",t).attr("data-state",this.opts.state),this.button=new ClefButton({el:e("#clef-button-target")[0]}),this.button.render()}}),this.TutorialView=r,this.SetupTutorialView=s,this.ConnectTutorialView=n}.call(this,jQuery,Backbone),function(e,t){var n;return n=t.View.extend({el:"#connect-clef-account",events:{"click #disconnect":"disconnectClefAccount"},disconnectURL:ajaxurl+"?action=disconnect_clef_account",messageTemplate:_.template("<div class='<%=type%> connect-clef-message'><%=message%></div>"),initialize:function(e){return this.opts=e,this.tutorial=new ConnectTutorialView(_.clone(this.opts)),this.disconnect=this.$el.find(".disconnect-clef"),this.listenTo(this.tutorial,"done",this.finishTutorial),this.render()},show:function(){return this.$el.fadeIn()},render:function(){return this.tutorial.render(),this.opts.connected?(this.tutorial.slideUp(),this.disconnect.show()):(this.disconnect.hide(),this.tutorial.show())},disconnectClefAccount:function(t){var n;return t.preventDefault(),n=function(e){return function(t){return e.showMessage({message:_.template(clefTranslations.messages.error.disconnect)({error:t}),type:"error"})}}(this),e.post(this.disconnectURL,{_wpnonce:this.opts.nonces.disconnectClef}).success(function(e){return function(t){var s;return t.success?(e.opts.connected=!1,e.render(),s=clefTranslations.messages.success.disconnect,e.showMessage({message:s,type:"updated"})):n(ClefUtils.getErrorMessage(t))}}(this)).fail(function(e){return n(e.responseText)})},showMessage:function(t){return this.message&&this.message.remove(),this.message=e(this.messageTemplate(t)).hide(),this.message.prependTo(this.$el).slideDown()},finishTutorial:function(){return window.location=""}}),window.ConnectView=n}.call(this,jQuery,Backbone);